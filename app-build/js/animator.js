define(["jquery","lib/Three","lib/requestAnimationFrame","lib/cancelAnimationFrame"],function(f,c,d,a){var b=function(g){this.opts=f.extend(true,{},b.opts,g);this._isRunning=false;this._actors=[];this._setupScene()};b.opts={mediator:null,container:"body",width:window.innerWidth,height:window.innerHeight,camera:{fov:75,aspect:window.innerWidth/window.innerHeight,near:1,far:10000,pos:[0,0,0]}};var e=b.prototype;e.start=function(){this._isRunning=true;this._render()};e.stop=function(){this._isRunning=false;a(this._timer)};e.isAnimated=function(){return this._isRunning==true};e.addActors=function(j){for(var h=0,g=j.length;h<g;++h){this._actors.push(j[h])}};e.getIntersects=function(i){var k=(i.clientX/this.opts.width)*2-1,j=-(i.clientY/this.opts.height)*2+1,h=new c.Vector3(k,j,0.5),g,l,m=null;this.projector.unprojectVector(h,this.camera);g=new c.Ray(this.camera.position,h.subSelf(this.camera.position).normalize());l=g.intersectObjects(this.scene.objects);return l};e._update=function(){var j=Object.prototype.hasOwnProperty,h=this.opts,i=h.mediator,g=this._actors;for(var k in g){if(j.call(g,k)){g[k]&&g[k].update&&g[k].update()}}i&&i.publish&&i.publish("actorsUpdated",this._timer)};e._render=function(){if(this._isRunning){var g=this;this._timer=d(function(h){g._render()});this._update();this.renderer.render(this.scene,this.camera)}};e._setupScene=function(){var g=this.opts;this.scene=new c.Scene();this.camera=new c.PerspectiveCamera(g.camera.fov,g.camera.aspect,g.camera.near,g.camera.far);this.camera.position=new c.Vector3(g.camera.pos[0],g.camera.pos[1],g.camera.pos[2]);this.scene.add(this.camera);this.renderer=new c.CanvasRenderer();this.renderer.setSize(g.width,g.height);f(this.opts.container).append(this.renderer.domElement);this.projector=new c.Projector()};return b});