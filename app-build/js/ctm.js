define(["jquery","lib/pubsub","animator","cube","textParticle","widget","graph"],function(e,a,c,h,g,d,b){var f={};f.init=function(){this.Scene.init();this.NetData.init();this.ViewGraph.init()};f.Scene={init:function(){this.painter=e("#painter");this.content=e("#content");this.initActor();this.initMessageResponse();this.bindEvent();this.animator.start()},initActor:function(){this.animator=new c({container:this.painter,camera:{pos:[0,0,550]},mediator:a});this.cube=new h({scene:this.animator.scene,size:200,pos:[-10,-20,-10000],rotSpeed:[1.8*0.005,2.4*0.005,0],textures:f.util.generateTextures("cube",6,".jpg")});this.textParticle=new g({scene:this.animator.scene,amount:31,textures:f.util.generateTextures("text",31,".png")});this.animator.addActors([this.cube,this.textParticle])},initMessageResponse:function(){var o=false,i=this.cube,l=this.animator,k=this.painter,n=this.content,m,j=e("#regionInfo");a.subscribe("actorsUpdated",function(q,p){if(i.arrviedEnd=="far"){l.stop();k.fadeOut("fast",function(){i.arrviedEnd="none";if(!l.isAnimated()){a.publish("animatorStopped",m);n.fadeIn("fast")}})}});a.subscribe("dataReceived",function(q,p){i.move({speed:[0,0,100],near:0})});a.subscribe("mouseOverCube",function(q,p){k[0].style.cursor="pointer";if(!o){i.stop();o=false}});a.subscribe("mouseOutCube",function(q,p){k[0].style.cursor="auto";i.start()});a.subscribe("mouseClickCube",function(q,p){i.move({speed:[140,75,-100],far:-2000});i.start();o=true;m=f.util.materialIndexToRegion[parseInt(p,10)];j.html(m.content)});a.subscribe("mouseClickBack",function(q,p){n.fadeOut("fast",function(){k.fadeIn("fast",function(){i.move({speed:[-140,-75,100],near:0});l.start();o=false})})})},bindEvent:function(){var k=this.animator,i=this.cube,j=this.painter,l=e("#cubeBack"),p=[];var n=function(q){p=k.getIntersects(q);if(p.length!=0){if(p[0].object.id==i.mesh.id){a.publish("mouseOverCube")}}else{a.publish("mouseOutCube")}},m=function(q){p=k.getIntersects(q);if(p.length!=0){if(p[0].object.id==i.mesh.id){a.publish("mouseClickCube",p[0].face.materialIndex)}}},o=function(q){a.publish("mouseClickBack")};j.on("click",m);j.on("mousemove",n);l.on("click",o)}};f.NetData={init:function(){this.fetch()},fetch:function(){var i=this;e.getJSON(f.config.fetchUrl,function(j){i.receivedData=j;a.publish("dataReceived")})},getData:function(n,l){var m=this.receivedData[n][l],o=[];for(var k=0,j=m.length;k<j;++k){o.push(e.extend({},m[k]))}return o},getLevelData:function(q,p){var n,r=this.getData(q,p),o=r.length,l,m,s,k=[-1];for(n=0;n<o;++n){m=r[n].data;s=m.length;k.push([m[0][0],m[s-1][0]])}k[0]=[k[1][0],k[k.length-1][1]];return k},getListData:function(r,q){var n,t=this.getData(r,q),p=t.length,l,m,u,s,o=[];for(n=0;n<p;++n){s=t[n].label.slice(0,2);m=t[n].data;u=m.length;for(l=0;l<u;++l){var k=m[l];o.push({l:s,f:k[1],d:k[2]})}}return o}};f.ViewGraph={init:function(){this.initWidget();this.initGraph();this.initMessageResponse();this.bindEvent();this.dataContainer.render()},initWidget:function(){this.tip=new d.Tip({cls:"data-info",tmpl:"<ul><li><em>内容: </em>{d}</li><li><em>频率: </em>{f}</li><li><em>级别: </em>{l}</li></ul>"});this.list=new d.List({cls:"data-list",tmpl:'<span class="f">{f}</span><span class="d">{d}</span><span class="l">{l}</span>'});this.dataContainer=new d.Base({cls:"data-container",header:e("<div/>").html('<span class="f">频率</span><span class="d">内容</span><span class="l">级别</span>'),container:e("#dataWin")})},initGraph:function(){var j=this.tip,i=this.list;this.graph=new b({renderTo:"placeHolder",config:{base:{xaxis:{tickDecimals:0,color:"#fff"},yaxis:{tickDecimals:0,color:"#fff"},grid:{backgroundColor:{colors:["#ffd986","#f9b447"]}}},ui:{back:{cls:"go-back"},tip:{cls:"usage-tip"},coord:{x:{content:"编号",cls:"coord-tip"},y:{content:"频<br/>率",cls:"coord-tip"}}}},events:{datapreprocess:function(o){var l=f.config.colors;for(var n=0,k=o.length;n<k;++n){var m=o[n];m.label&&(m.label=m.label+"<{count}>");m.color=l[n]}return o},datarangeselect:function(k){},datapointhover:{hoverin:function(l,k){j.render({data:{d:k.data,f:k.y,l:k.label.slice(0,2)},style:{top:l.top,left:l.left,backgroundColor:k.color}});i.slideTo(k.x,{backgroundColor:k.color,"border-radius":3})},hoverout:function(){j.unrender()}}}})},initMessageResponse:function(){var n=this.graph,m=this.list,p=this.dataContainer,o,l="char",k=e("#typeMenu").find("button"),j=e("#levelMenu").find("button"),i=this;a.subscribe("animatorStopped",function(r,q){k.removeClass("checked");j.removeClass("checked");e(k[0]).addClass("checked");e(j[0]).addClass("checked");o=q.region;i._render(o,"char")});a.subscribe("mouseClickTypeButton",function(q,r){l=r;i._render(o,l)});a.subscribe("mouseClickLevelButton",function(r,u){var s=f.NetData.getLevelData(o,l),v=parseInt(u,10),q=s[v],t=n.getRenderData(q[0],q[1]);n.redraw(t);n.resetHist(t)});a.subscribe("mouseClickSearchButton",function(w,u){var t=f.NetData.getListData(o,l),r=f.config.colors;for(var s=0,q=t.length;s<q;++s){if(t[s].d==u){var v=parseInt(t[s].l,10);m.slideTo(s+1,{backgroundColor:r[v-1],"border-radius":3});break}}if(s>=q){alert("无法找到:"+u)}})},bindEvent:function(){var i=e("#levelMenu").find("button"),k=e("#typeMenu").find("button"),l=e("#searchKey"),j=e("#searchForm");k.on("click",function(m){var o=e(this),n=o.val();if(o.hasClass("checked")){return}k.removeClass("checked");o.addClass("checked");i.removeClass("checked");e(i[0]).addClass("checked");a.publish("mouseClickTypeButton",n)});i.on("click",function(m){var o=e(this),n=o.val();if(o.hasClass("checked")){return}i.removeClass("checked");o.addClass("checked");a.publish("mouseClickLevelButton",n)});l.on("focusin",function(m){if(e.trim(l.val())=="搜索..."){l.removeClass("search-key").val("")}});l.on("focusout",function(m){if(e.trim(l.val())==""){l.addClass("search-key").val("搜索...")}});j.on("submit",function(m){m.preventDefault();var n=e.trim(l.val());a.publish("mouseClickSearchButton",n)})},_render:function(n,i){var m=this.graph,l=this.list,o=this.dataContainer,k=f.NetData.getData(n,i),j=f.NetData.getListData(n,i);setTimeout(function(){console.time("render graph");m.render(k);console.timeEnd("render graph")},0);setTimeout(function(){console.time("render data list");var p=l.render(j).html();console.timeEnd("render data list");console.time("render data container");o.update({body:p});console.timeEnd("render data container")},0)}};f.config={fetchUrl:"data/fetchdata.php",textureUrl:"image/textures/",colors:["#e44323","#3686cc","#6caf24","#806061"]};f.util={generateTextures:function(o,m,n){var k=f.config.textureUrl,j=[];for(var l=1;l<=m;++l){j.push(k+o+"/"+l+n)}return j},materialIndexToRegion:[{region:"all",content:"全部"},{region:"all",content:"全部"},{region:"ml",content:"大陆"},{region:"hmt",content:"港澳台"},{region:"jk",content:"日韩"},{region:"other",content:"其它"}]};return f});