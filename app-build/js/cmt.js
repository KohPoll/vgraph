define(["jquery","lib/pubsub","animator","cube","textParticle","widget","graph"],function(k,o,m,i,j,l,n){var p={};p.init=function(){this.Scene.init();this.NetData.init();this.ViewGraph.init()};p.Scene={init:function(){this.painter=k("#painter");this.content=k("#content");this.initActor();this.initMessageResponse();this.bindEvent();this.animator.start()},initActor:function(){this.animator=new m({container:this.painter,camera:{pos:[0,0,550]},mediator:o});this.cube=new i({scene:this.animator.scene,size:200,pos:[-10,-20,-10000],rotSpeed:[1.8*0.005,2.4*0.005,0],textures:p.util.generateTextures("cube",6,".jpg")});this.textParticle=new j({scene:this.animator.scene,amount:31,textures:p.util.generateTextures("text",31,".png")});this.animator.addActors([this.cube,this.textParticle])},initMessageResponse:function(){var b=false,a=this.cube,e=this.animator,f=this.painter,c=this.content,d,g=k("#regionInfo");o.subscribe("actorsUpdated",function(r,h){if(a.arrviedEnd=="far"){e.stop();f.fadeOut("fast",function(){a.arrviedEnd="none";if(!e.isAnimated()){o.publish("animatorStopped",d);c.fadeIn("fast")}})}});o.subscribe("dataReceived",function(r,h){a.move({speed:[0,0,100],near:0})});o.subscribe("mouseOverCube",function(r,h){f[0].style.cursor="pointer";if(!b){a.stop();b=false}});o.subscribe("mouseOutCube",function(r,h){f[0].style.cursor="auto";a.start()});o.subscribe("mouseClickCube",function(r,h){a.move({speed:[140,75,-100],far:-2000});a.start();b=true;d=p.util.materialIndexToRegion[parseInt(h,10)];g.html(d.content)});o.subscribe("mouseClickBack",function(r,h){c.fadeOut("fast",function(){f.fadeIn("fast",function(){a.move({speed:[-140,-75,100],near:0});e.start();b=false})})})},bindEvent:function(){var f=this.animator,h=this.cube,g=this.painter,e=k("#cubeBack"),a=[];var c=function(r){a=f.getIntersects(r);if(a.length!=0){if(a[0].object.id==h.mesh.id){o.publish("mouseOverCube")}}else{o.publish("mouseOutCube")}},d=function(r){a=f.getIntersects(r);if(a.length!=0){if(a[0].object.id==h.mesh.id){o.publish("mouseClickCube",a[0].face.materialIndex)}}},b=function(r){o.publish("mouseClickBack")};g.on("click",d);g.on("mousemove",c);e.on("click",b)}};p.NetData={init:function(){this.fetch()},fetch:function(){var a=this;k.getJSON(p.config.fetchUrl,function(b){a.receivedData=b;o.publish("dataReceived")})},getData:function(c,e){var d=this.receivedData[c][e],b=[];for(var f=0,a=d.length;f<a;++f){b.push(k.extend({},d[f]))}return b},getLevelData:function(c,d){var f,b=this.getData(c,d),e=b.length,h,g,a,r=[-1];for(f=0;f<e;++f){g=b[f].data;a=g.length;r.push([g[0][0],g[a-1][0]])}r[0]=[r[1][0],r[r.length-1][1]];return r},getListData:function(b,d){var g,a=this.getData(b,d),e=a.length,t,h,v,c,f=[];for(g=0;g<e;++g){c=a[g].label.slice(0,2);h=a[g].data;v=h.length;for(t=0;t<v;++t){var u=h[t];f.push({l:c,f:u[1],d:u[2]})}}return f}};p.ViewGraph={init:function(){this.initWidget();this.initGraph();this.initMessageResponse();this.bindEvent();this.dataContainer.render()},initWidget:function(){this.tip=new l.Tip({cls:"data-info",tmpl:"<ul><li><em>内容: </em>{d}</li><li><em>频率: </em>{f}</li><li><em>级别: </em>{l}</li></ul>"});this.list=new l.List({cls:"data-list",tmpl:'<span class="f">{f}</span><span class="d">{d}</span><span class="l">{l}</span>'});this.dataContainer=new l.Base({cls:"data-container",header:k("<div/>").html('<span class="f">频率</span><span class="d">内容</span><span class="l">级别</span>'),container:k("#dataWin")})},initGraph:function(){var a=this.tip,b=this.list;this.graph=new n({renderTo:"placeHolder",config:{base:{xaxis:{tickDecimals:0,color:"#fff"},yaxis:{tickDecimals:0,color:"#fff"},grid:{backgroundColor:{colors:["#ffd986","#f9b447"]}}},ui:{back:{cls:"go-back"},tip:{cls:"usage-tip"},coord:{x:{content:"编号",cls:"coord-tip"},y:{content:"频<br/>率",cls:"coord-tip"}}}},events:{datapreprocess:function(d){var g=p.config.colors;for(var e=0,c=d.length;e<c;++e){var f=d[e];f.label&&(f.label=f.label+"<{count}>");f.color=g[e]}return d},datarangeselect:function(c){},datapointhover:{hoverin:function(c,d){a.render({data:{d:d.data,f:d.y,l:d.label.slice(0,2)},style:{top:c.top,left:c.left,backgroundColor:d.color}});b.slideTo(d.x,{backgroundColor:d.color,"border-radius":3})},hoverout:function(){a.unrender()}}}})},initMessageResponse:function(){var c=this.graph,d=this.list,a=this.dataContainer,b,e="char",f=k("#typeMenu").find("button"),g=k("#levelMenu").find("button"),h=this;o.subscribe("animatorStopped",function(s,t){f.removeClass("checked");g.removeClass("checked");k(f[0]).addClass("checked");k(g[0]).addClass("checked");b=t.region;h._render(b,"char")});o.subscribe("mouseClickTypeButton",function(t,s){e=s;h._render(b,e)});o.subscribe("mouseClickLevelButton",function(A,B){var y=p.NetData.getLevelData(b,e),z=parseInt(B,10),w=y[z],x=c.getRenderData(w[0],w[1]);c.redraw(x);c.resetHist(x)});o.subscribe("mouseClickSearchButton",function(C,z){var D=p.NetData.getListData(b,e),A=p.config.colors;for(var x=0,B=D.length;x<B;++x){if(D[x].d==z){var y=parseInt(D[x].l,10);d.slideTo(x+1,{backgroundColor:A[y-1],"border-radius":3});break}}if(x>=B){alert("无法找到:"+z)}})},bindEvent:function(){var b=k("#levelMenu").find("button"),d=k("#typeMenu").find("button"),c=k("#searchKey"),a=k("#searchForm");d.on("click",function(f){var g=k(this),e=g.val();if(g.hasClass("checked")){return}d.removeClass("checked");g.addClass("checked");b.removeClass("checked");k(b[0]).addClass("checked");o.publish("mouseClickTypeButton",e)});b.on("click",function(f){var g=k(this),e=g.val();if(g.hasClass("checked")){return}b.removeClass("checked");g.addClass("checked");o.publish("mouseClickLevelButton",e)});c.on("focusin",function(e){if(k.trim(c.val())=="搜索..."){c.removeClass("search-key").val("")}});c.on("focusout",function(e){if(k.trim(c.val())==""){c.addClass("search-key").val("搜索...")}});a.on("submit",function(f){f.preventDefault();var e=k.trim(c.val());o.publish("mouseClickSearchButton",e)})},_render:function(c,a){var d=this.graph,e=this.list,b=this.dataContainer,f=p.NetData.getData(c,a),g=p.NetData.getListData(c,a);setTimeout(function(){console.time("render graph");d.render(f);console.timeEnd("render graph")},0);setTimeout(function(){console.time("render data list");var h=e.render(g).html();console.timeEnd("render data list");console.time("render data container");b.update({body:h});console.timeEnd("render data container")},0)}};p.config={fetchUrl:"data/fetchdata.php",textureUrl:"image/textures/",colors:["#e44323","#3686cc","#6caf24","#806061"]};p.util={generateTextures:function(b,d,c){var f=p.config.textureUrl,a=[];for(var e=1;e<=d;++e){a.push(f+b+"/"+e+c)}return a},materialIndexToRegion:[{region:"all",content:"全部"},{region:"all",content:"全部"},{region:"ml",content:"大陆"},{region:"hmt",content:"港澳台"},{region:"jk",content:"日韩"},{region:"other",content:"其它"}]};return p});