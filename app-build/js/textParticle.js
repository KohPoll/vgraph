define(["lib/Three"],function(a){var b=function(){var f=new a.Vector3(),i,h=600,j=700,l=200,k,g=160,d=4,e=0.01,m=false;this.position=new a.Vector3();this.velocity=new a.Vector3();i=new a.Vector3();this.setGoal=function(n){k=n};this.setAvoidWalls=function(n){m=n};this.setWorldSize=function(o,n,p){h=o;j=n;f;l=p};this.run=function(n){if(m){f.set(-h,this.position.y,this.position.z);f=this.avoid(f);f.multiplyScalar(5);i.addSelf(f);f.set(h,this.position.y,this.position.z);f=this.avoid(f);f.multiplyScalar(5);i.addSelf(f);f.set(this.position.x,-j,this.position.z);f=this.avoid(f);f.multiplyScalar(5);i.addSelf(f);f.set(this.position.x,j,this.position.z);f=this.avoid(f);f.multiplyScalar(5);i.addSelf(f);f.set(this.position.x,this.position.y,-l);f=this.avoid(f);f.multiplyScalar(5);i.addSelf(f);f.set(this.position.x,this.position.y,l);f=this.avoid(f);f.multiplyScalar(5);i.addSelf(f)}if(Math.random()>0.5){this.flock(n)}this.move()};this.flock=function(n){if(k){i.addSelf(this.reach(k,0.005))}i.addSelf(this.alignment(n));i.addSelf(this.cohesion(n));i.addSelf(this.separation(n))};this.move=function(){this.velocity.addSelf(i);var n=this.velocity.length();if(n>d){this.velocity.divideScalar(n/d)}this.position.addSelf(this.velocity);i.set(0,0,0)};this.checkBounds=function(){if(this.position.x>h){this.position.x=-h}if(this.position.x<-h){this.position.x=h}if(this.position.y>j){this.position.y=-j}if(this.position.y<-j){this.position.y=j}if(this.position.z>l){this.position.z=-l}if(this.position.z<-l){this.position.z=l}};this.avoid=function(o){var n=new a.Vector3();n.copy(this.position);n.subSelf(o);n.multiplyScalar(1/this.position.distanceToSquared(o));return n};this.repulse=function(o){var p=this.position.distanceTo(o);if(p<250){var n=new a.Vector3();n.sub(this.position,o);n.multiplyScalar(0.5/p);i.addSelf(n)}};this.reach=function(p,o){var n=new a.Vector3();n.sub(p,this.position);n.multiplyScalar(o);return n};this.alignment=function(s){var t,p=new a.Vector3(),r=0;for(var q=0,o=s.length;q<o;q++){if(Math.random()>0.6){continue}t=s[q];distance=t.position.distanceTo(this.position);if(distance>0&&distance<=g){p.addSelf(t.velocity);r++}}if(r>0){p.divideScalar(r);var n=p.length();if(n>e){p.divideScalar(n/e)}}return p};this.cohesion=function(r){var u,n,p=new a.Vector3(),t=new a.Vector3(),s=0;for(var q=0,v=r.length;q<v;q++){if(Math.random()>0.6){continue}u=r[q];n=u.position.distanceTo(this.position);if(n>0&&n<=g){p.addSelf(u.position);s++}}if(s>0){p.divideScalar(s)}t.sub(p,this.position);var o=t.length();if(o>e){t.divideScalar(o/e)}return t};this.separation=function(q){var s,t,o=new a.Vector3(),r=new a.Vector3();for(var p=0,n=q.length;p<n;p++){if(Math.random()>0.6){continue}s=q[p];t=s.position.distanceTo(this.position);if(t>0&&t<=g){r.sub(this.position,s.position);r.normalize();r.divideScalar(t);o.addSelf(r)}}return o}};function c(d){d=d||{};this._init(d)}c.prototype.update=function(){var g=Math.random(),e=0,j,h;if(g>=0.55){e=0.002}for(var f=0,d=this.particles.length;f<d;f++){j=this.boids[f];j.run(this.boids);h=this.particles[f];e&&(h.material.opacity-=e);if(h.material.opacity<0){h.material.opacity=1}j&&j.repulse(new a.Vector3(-20,-20,0))}};c.prototype._init=function(d){var g=d.amount||26,m=d.textures||[],k=d.opacitys||[],f=d.scene,l;this.particles=[];this.boids=[];for(var e=0;e<g;e++){l=this.boids[e]=new b();l.position.x=Math.random()*300-200;l.position.y=Math.random()*400-200;l.position.z=Math.random()*400-200;l.velocity.x=Math.random()*2-1.5;l.velocity.y=Math.random()*2-1.5;l.velocity.z=Math.random()*2-1.5;l.setAvoidWalls(true);l.setWorldSize(800,400,900);var h=k[e]||(0.1+Math.random()*0.9),j=m[e]||"textures/h.jpg";this.particles[e]=new a.Particle(new a.ParticleBasicMaterial({map:a.ImageUtils.loadTexture(j),opacity:h}));this.particles[e].position=this.boids[e].position;this.particles[e].doubleSided=true;f&&f.add&&f.add(this.particles[e])}};return c});