define(["lib/Three"],function(e){var d=function(){var r=new e.Vector3(),o,p=600,n=700,b=200,c,q=160,t=4,s=0.01,a=false;this.position=new e.Vector3();this.velocity=new e.Vector3();o=new e.Vector3();this.setGoal=function(g){c=g};this.setAvoidWalls=function(g){a=g};this.setWorldSize=function(h,i,g){p=h;n=i;r;b=g};this.run=function(g){if(a){r.set(-p,this.position.y,this.position.z);r=this.avoid(r);r.multiplyScalar(5);o.addSelf(r);r.set(p,this.position.y,this.position.z);r=this.avoid(r);r.multiplyScalar(5);o.addSelf(r);r.set(this.position.x,-n,this.position.z);r=this.avoid(r);r.multiplyScalar(5);o.addSelf(r);r.set(this.position.x,n,this.position.z);r=this.avoid(r);r.multiplyScalar(5);o.addSelf(r);r.set(this.position.x,this.position.y,-b);r=this.avoid(r);r.multiplyScalar(5);o.addSelf(r);r.set(this.position.x,this.position.y,b);r=this.avoid(r);r.multiplyScalar(5);o.addSelf(r)}if(Math.random()>0.5){this.flock(g)}this.move()};this.flock=function(g){if(c){o.addSelf(this.reach(c,0.005))}o.addSelf(this.alignment(g));o.addSelf(this.cohesion(g));o.addSelf(this.separation(g))};this.move=function(){this.velocity.addSelf(o);var g=this.velocity.length();if(g>t){this.velocity.divideScalar(g/t)}this.position.addSelf(this.velocity);o.set(0,0,0)};this.checkBounds=function(){if(this.position.x>p){this.position.x=-p}if(this.position.x<-p){this.position.x=p}if(this.position.y>n){this.position.y=-n}if(this.position.y<-n){this.position.y=n}if(this.position.z>b){this.position.z=-b}if(this.position.z<-b){this.position.z=b}};this.avoid=function(g){var h=new e.Vector3();h.copy(this.position);h.subSelf(g);h.multiplyScalar(1/this.position.distanceToSquared(g));return h};this.repulse=function(h){var g=this.position.distanceTo(h);if(g<250){var i=new e.Vector3();i.sub(this.position,h);i.multiplyScalar(0.5/g);o.addSelf(i)}};this.reach=function(g,h){var i=new e.Vector3();i.sub(g,this.position);i.multiplyScalar(h);return i};this.alignment=function(h){var g,k=new e.Vector3(),i=0;for(var j=0,l=h.length;j<l;j++){if(Math.random()>0.6){continue}g=h[j];distance=g.position.distanceTo(this.position);if(distance>0&&distance<=q){k.addSelf(g.velocity);i++}}if(i>0){k.divideScalar(i);var m=k.length();if(m>s){k.divideScalar(m/s)}}return k};this.cohesion=function(g){var m,k,i=new e.Vector3(),w=new e.Vector3(),x=0;for(var h=0,l=g.length;h<l;h++){if(Math.random()>0.6){continue}m=g[h];k=m.position.distanceTo(this.position);if(k>0&&k<=q){i.addSelf(m.position);x++}}if(x>0){i.divideScalar(x)}w.sub(i,this.position);var j=w.length();if(j>s){w.divideScalar(j/s)}return w};this.separation=function(j){var h,g,l=new e.Vector3(),i=new e.Vector3();for(var k=0,m=j.length;k<m;k++){if(Math.random()>0.6){continue}h=j[k];g=h.position.distanceTo(this.position);if(g>0&&g<=q){i.sub(this.position,h.position);i.normalize();i.divideScalar(g);l.addSelf(i)}}return l}};function f(a){a=a||{};this._init(a)}f.prototype.update=function(){var c=Math.random(),k=0,a,b;if(c>=0.55){k=0.002}for(var i=0,l=this.particles.length;i<l;i++){a=this.boids[i];a.run(this.boids);b=this.particles[i];k&&(b.material.opacity-=k);if(b.material.opacity<0){b.material.opacity=1}a&&a.repulse(new e.Vector3(-20,-20,0))}};f.prototype._init=function(r){var o=r.amount||26,a=r.textures||[],c=r.opacitys||[],p=r.scene,b;this.particles=[];this.boids=[];for(var q=0;q<o;q++){b=this.boids[q]=new d();b.position.x=Math.random()*300-200;b.position.y=Math.random()*400-200;b.position.z=Math.random()*400-200;b.velocity.x=Math.random()*2-1.5;b.velocity.y=Math.random()*2-1.5;b.velocity.z=Math.random()*2-1.5;b.setAvoidWalls(true);b.setWorldSize(800,400,900);var n=c[q]||(0.1+Math.random()*0.9),i=a[q]||"textures/h.jpg";this.particles[q]=new e.Particle(new e.ParticleBasicMaterial({map:e.ImageUtils.loadTexture(i),opacity:n}));this.particles[q].position=this.boids[q].position;this.particles[q].doubleSided=true;p&&p.add&&p.add(this.particles[q])}};return f});