define(["lib/Three"],function(d){var f=function(){var t=new d.Vector3(),q,r=600,p=700,n=200,o,s=160,b=4,a=0.01,c=false;this.position=new d.Vector3();this.velocity=new d.Vector3();q=new d.Vector3();this.setGoal=function(g){o=g};this.setAvoidWalls=function(g){c=g};this.setWorldSize=function(h,i,g){r=h;p=i;t;n=g};this.run=function(g){if(c){t.set(-r,this.position.y,this.position.z);t=this.avoid(t);t.multiplyScalar(5);q.addSelf(t);t.set(r,this.position.y,this.position.z);t=this.avoid(t);t.multiplyScalar(5);q.addSelf(t);t.set(this.position.x,-p,this.position.z);t=this.avoid(t);t.multiplyScalar(5);q.addSelf(t);t.set(this.position.x,p,this.position.z);t=this.avoid(t);t.multiplyScalar(5);q.addSelf(t);t.set(this.position.x,this.position.y,-n);t=this.avoid(t);t.multiplyScalar(5);q.addSelf(t);t.set(this.position.x,this.position.y,n);t=this.avoid(t);t.multiplyScalar(5);q.addSelf(t)}if(Math.random()>0.5){this.flock(g)}this.move()};this.flock=function(g){if(o){q.addSelf(this.reach(o,0.005))}q.addSelf(this.alignment(g));q.addSelf(this.cohesion(g));q.addSelf(this.separation(g))};this.move=function(){this.velocity.addSelf(q);var g=this.velocity.length();if(g>b){this.velocity.divideScalar(g/b)}this.position.addSelf(this.velocity);q.set(0,0,0)};this.checkBounds=function(){if(this.position.x>r){this.position.x=-r}if(this.position.x<-r){this.position.x=r}if(this.position.y>p){this.position.y=-p}if(this.position.y<-p){this.position.y=p}if(this.position.z>n){this.position.z=-n}if(this.position.z<-n){this.position.z=n}};this.avoid=function(g){var h=new d.Vector3();h.copy(this.position);h.subSelf(g);h.multiplyScalar(1/this.position.distanceToSquared(g));return h};this.repulse=function(h){var g=this.position.distanceTo(h);if(g<250){var i=new d.Vector3();i.sub(this.position,h);i.multiplyScalar(0.5/g);q.addSelf(i)}};this.reach=function(g,h){var i=new d.Vector3();i.sub(g,this.position);i.multiplyScalar(h);return i};this.alignment=function(h){var g,k=new d.Vector3(),i=0;for(var j=0,l=h.length;j<l;j++){if(Math.random()>0.6){continue}g=h[j];distance=g.position.distanceTo(this.position);if(distance>0&&distance<=s){k.addSelf(g.velocity);i++}}if(i>0){k.divideScalar(i);var m=k.length();if(m>a){k.divideScalar(m/a)}}return k};this.cohesion=function(w){var k,i,g=new d.Vector3(),l=new d.Vector3(),m=0;for(var x=0,j=w.length;x<j;x++){if(Math.random()>0.6){continue}k=w[x];i=k.position.distanceTo(this.position);if(i>0&&i<=s){g.addSelf(k.position);m++}}if(m>0){g.divideScalar(m)}l.sub(g,this.position);var h=l.length();if(h>a){l.divideScalar(h/a)}return l};this.separation=function(j){var h,g,l=new d.Vector3(),i=new d.Vector3();for(var k=0,m=j.length;k<m;k++){if(Math.random()>0.6){continue}h=j[k];g=h.position.distanceTo(this.position);if(g>0&&g<=s){i.sub(this.position,h.position);i.normalize();i.divideScalar(g);l.addSelf(i)}}return l}};function e(a){a=a||{};this._init(a)}e.prototype.update=function(){var a=Math.random(),c=0,i,l;if(a>=0.55){c=0.002}for(var b=0,k=this.particles.length;b<k;b++){i=this.boids[b];i.run(this.boids);l=this.particles[b];c&&(l.material.opacity-=c);if(l.material.opacity<0){l.material.opacity=1}i&&i.repulse(new d.Vector3(-20,-20,0))}};e.prototype._init=function(r){var o=r.amount||26,a=r.textures||[],c=r.opacitys||[],p=r.scene,b;this.particles=[];this.boids=[];for(var q=0;q<o;q++){b=this.boids[q]=new f();b.position.x=Math.random()*300-200;b.position.y=Math.random()*400-200;b.position.z=Math.random()*400-200;b.velocity.x=Math.random()*2-1.5;b.velocity.y=Math.random()*2-1.5;b.velocity.z=Math.random()*2-1.5;b.setAvoidWalls(true);b.setWorldSize(800,400,900);var n=c[q]||(0.1+Math.random()*0.9),i=a[q]||"textures/h.jpg";this.particles[q]=new d.Particle(new d.ParticleBasicMaterial({map:d.ImageUtils.loadTexture(i),opacity:n}));this.particles[q].position=this.boids[q].position;this.particles[q].doubleSided=true;p&&p.add&&p.add(this.particles[q])}};return e});