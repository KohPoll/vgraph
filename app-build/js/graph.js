define(["jquery","lib/jquery.template","order!lib/flot/jquery.flot","order!lib/flot/jquery.flot.selection"],function(g){var h=function(){};var f=function(a){var b=[];a.renderTo&&(b=g("#"+a.renderTo));if(!b.length){throw new Error("no render container")}this.renderdata=[];this.config=g.extend(true,{},f.__config,a.config);this.events=g.extend(true,{},f.__events,a.events);this.plot=g.plot(b[0],this.renderdata,this.config.base);this.placeholder=this.plot.getPlaceholder();this._renderUI();this._bindEvents()};var e=f.prototype;e.render=function(a){a=this.events.datapreprocess(a);this.renderdata=this.events._datapreprocess(a);this.resetHist(this.renderdata);this.redraw(this.renderdata)};e.redraw=function(a){this.plot.setData(a);this.plot.setupGrid();this.plot.draw();this.plot.clearSelection()};e.resetHist=function(a){this.renderhist=[];this.renderhist[0]=a};e.getRenderData=function(b,q){var c,d,a=this.renderdata,o=[];if(typeof b=="undefined"&&typeof q=="undefined"){return a}for(var i=0,p=a.length;i<p;++i){c=g.extend(true,{},a[i]);d=g.grep(c.data,function(k,j){return k[0]>=b&&k[0]<=q});if(d.length!==0){c.data=d;o.push(c)}}return o};e._transToPointData=function(p){var j=[],a,b;for(var c=0,o=p.length;c<o;++c){a=p[c];b=a.data;for(var i=0,d=b.length;i<d;++i){if(b[i][2]){j.push({x:b[i][0],y:b[i][1],color:a.color,label:a.label,data:b[i][2]})}}}return j};e._renderUI=function(){var p=this.config.ui,a=this.placeholder,q=a.width(),d=a.height(),c,b,o,n;b=g("<div>").html(p.coord.x.content).addClass(p.coord.x.cls).css({position:"absolute",bottom:-15,left:q-50});o=g("<div>").html(p.coord.y.content).addClass(p.coord.y.cls).css({position:"absolute",top:5,left:-20});c=g("<div>").html(p.tip.content).addClass(p.tip.cls).css({position:"absolute",top:25,left:120});n=g("<div>").html(p.back.content).attr("title",p.back.content).addClass(p.back.cls).bind("click",(function(i){return function(j){i._goBack()}})(this));a.append(c).append(b).append(o).append(n)};e._goBack=function(){var a=this.renderhist.length;if(a===1){return}this.renderhist.pop();a=this.renderhist.length;this.redraw(this.renderhist[a-1])};e._bindEvents=function(){var c=this;a();b();function b(){var d=c.events.datarangeselect;c.placeholder.unbind("plotselected").bind("plotselected",function(p,q){var n=Math.ceil(q.xaxis.from),r=Math.floor(q.xaxis.to);if(n>r){c.plot.clearSelection();return}var o=c.getRenderData(n,r);c.redraw(o);c.renderhist.push(o);d.call(c,c._transToPointData(o))})}function a(){var d=null,n=null,m=c.events.datapointhover.hoverin,l=c.events.datapointhover.hoverout;c.placeholder.unbind("plothover").bind("plothover",function(j,k,i){if(i){if(n!==i.dataIndex){n=i.dataIndex;clearTimeout(d);d=setTimeout(function(){var s=(g.grep(i.series.data,function(o,p){return o[0]===i.datapoint[0]&&o[1]===i.datapoint[1]}))[0];var t={x:s[0],y:s[1],color:i.series.color,label:i.series.label,data:s[2]};var r={top:i.pageY,left:i.pageX};m.call(c,r,t)},150)}}else{clearTimeout(d);l.call(c);n=null}})}};f.__config={base:{series:{lines:{show:true},points:{show:true}},grid:{hoverable:true,clickable:true},selection:{mode:"x"}},ui:{back:{content:"返回上一框选范围",cls:""},tip:{content:"可使用鼠标拖拽框选范围(按住鼠标左键,移动鼠标以框选范围)",cls:""},coord:{x:{content:"x轴",cls:""},y:{content:"y轴",cls:""}}}};f.__events={_datapreprocess:function(a){a=a||[];for(var b=0,d=a.length;b<d;++b){var c=a[b];if(c.label){c.label=g.tmpl.object(c.label,{count:c.data.length})}}return a},datapreprocess:function(a){return a},datarangeselect:h,datapointhover:{hoverin:h,hoverout:h}};return f});