define(["jquery","lib/jquery.template","order!lib/flot/jquery.flot","order!lib/flot/jquery.flot.selection"],function(d){var c=function(){};var a=function(f){var e=[];f.renderTo&&(e=d("#"+f.renderTo));if(!e.length){throw new Error("no render container")}this.renderdata=[];this.config=d.extend(true,{},a.__config,f.config);this.events=d.extend(true,{},a.__events,f.events);this.plot=d.plot(e[0],this.renderdata,this.config.base);this.placeholder=this.plot.getPlaceholder();this._renderUI();this._bindEvents()};var b=a.prototype;b.render=function(e){e=this.events.datapreprocess(e);this.renderdata=this.events._datapreprocess(e);this.resetHist(this.renderdata);this.redraw(this.renderdata)};b.redraw=function(e){this.plot.setData(e);this.plot.setupGrid();this.plot.draw();this.plot.clearSelection()};b.resetHist=function(e){this.renderhist=[];this.renderhist[0]=e};b.getRenderData=function(l,n){var k,j,m=this.renderdata,g=[];if(typeof l=="undefined"&&typeof n=="undefined"){return m}for(var h=0,f=m.length;h<f;++h){k=d.extend(true,{},m[h]);j=d.grep(k.data,function(o,e){return o[0]>=l&&o[0]<=n});if(j.length!==0){k.data=j;g.push(k)}}return g};b._transToPointData=function(n){var f=[],m,l;for(var k=0,e=n.length;k<e;++k){m=n[k];l=m.data;for(var g=0,h=l.length;g<h;++g){if(l[g][2]){f.push({x:l[g][0],y:l[g][1],color:m.color,label:m.label,data:l[g][2]})}}}return f};b._renderUI=function(){var f=this.config.ui,m=this.placeholder,e=m.width(),j=m.height(),k,l,g,i;l=d("<div>").html(f.coord.x.content).addClass(f.coord.x.cls).css({position:"absolute",bottom:-15,left:e-50});g=d("<div>").html(f.coord.y.content).addClass(f.coord.y.cls).css({position:"absolute",top:5,left:-20});k=d("<div>").html(f.tip.content).addClass(f.tip.cls).css({position:"absolute",top:25,left:120});i=d("<div>").html(f.back.content).attr("title",f.back.content).addClass(f.back.cls).bind("click",(function(h){return function(n){h._goBack()}})(this));m.append(k).append(l).append(g).append(i)};b._goBack=function(){var e=this.renderhist.length;if(e===1){return}this.renderhist.pop();e=this.renderhist.length;this.redraw(this.renderhist[e-1])};b._bindEvents=function(){var e=this;g();f();function f(){var h=e.events.datarangeselect;e.placeholder.unbind("plotselected").bind("plotselected",function(k,j){var m=Math.ceil(j.xaxis.from),i=Math.floor(j.xaxis.to);if(m>i){e.plot.clearSelection();return}var l=e.getRenderData(m,i);e.redraw(l);e.renderhist.push(l);h.call(e,e._transToPointData(l))})}function g(){var k=null,h=null,i=e.events.datapointhover["hoverin"],j=e.events.datapointhover["hoverout"];e.placeholder.unbind("plothover").bind("plothover",function(l,n,m){if(m){if(h!==m.dataIndex){h=m.dataIndex;clearTimeout(k);k=setTimeout(function(){var p=(d.grep(m.series.data,function(s,r){return s[0]===m.datapoint[0]&&s[1]===m.datapoint[1]}))[0];var o={x:p[0],y:p[1],color:m.series.color,label:m.series.label,data:p[2]};var q={top:m.pageY,left:m.pageX};i.call(e,q,o)},150)}}else{clearTimeout(k);j.call(e);h=null}})}};a.__config={base:{series:{lines:{show:true},points:{show:true}},grid:{hoverable:true,clickable:true},selection:{mode:"x"}},ui:{back:{content:"返回上一框选范围",cls:""},tip:{content:"可使用鼠标拖拽框选范围(按住鼠标左键,移动鼠标以框选范围)",cls:""},coord:{x:{content:"x轴",cls:""},y:{content:"y轴",cls:""}}}};a.__events={_datapreprocess:function(h){h=h||[];for(var g=0,e=h.length;g<e;++g){var f=h[g];if(f.label){f.label=d.tmpl.object(f.label,{count:f.data.length})}}return h},datapreprocess:function(e){return e},datarangeselect:c,datapointhover:{hoverin:c,hoverout:c}};return a});