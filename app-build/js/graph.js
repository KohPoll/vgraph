define(["jquery","lib/jquery.template","order!lib/flot/jquery.flot","order!lib/flot/jquery.flot.selection"],function(e){var f=function(){};var h=function(a){var b=[];a.renderTo&&(b=e("#"+a.renderTo));if(!b.length){throw new Error("no render container")}this.renderdata=[];this.config=e.extend(true,{},h.__config,a.config);this.events=e.extend(true,{},h.__events,a.events);this.plot=e.plot(b[0],this.renderdata,this.config.base);this.placeholder=this.plot.getPlaceholder();this._renderUI();this._bindEvents()};var g=h.prototype;g.render=function(a){a=this.events.datapreprocess(a);this.renderdata=this.events._datapreprocess(a);this.resetHist(this.renderdata);this.redraw(this.renderdata)};g.redraw=function(a){this.plot.setData(a);this.plot.setupGrid();this.plot.draw();this.plot.clearSelection()};g.resetHist=function(a){this.renderhist=[];this.renderhist[0]=a};g.getRenderData=function(p,i){var a,b,o=this.renderdata,c=[];if(typeof p=="undefined"&&typeof i=="undefined"){return o}for(var n=0,d=o.length;n<d;++n){a=e.extend(true,{},o[n]);b=e.grep(a.data,function(j,k){return j[0]>=p&&j[0]<=i});if(b.length!==0){a.data=b;c.push(a)}}return c};g._transToPointData=function(c){var i=[],j,o;for(var p=0,a=c.length;p<a;++p){j=c[p];o=j.data;for(var d=0,b=o.length;d<b;++d){if(o[d][2]){i.push({x:o[d][0],y:o[d][1],color:j.color,label:j.label,data:o[d][2]})}}}return i};g._renderUI=function(){var m=this.config.ui,o=this.placeholder,n=o.width(),c=o.height(),a,p,d,b;p=e("<div>").html(m.coord.x.content).addClass(m.coord.x.cls).css({position:"absolute",bottom:-15,left:n-50});d=e("<div>").html(m.coord.y.content).addClass(m.coord.y.cls).css({position:"absolute",top:5,left:-20});a=e("<div>").html(m.tip.content).addClass(m.tip.cls).css({position:"absolute",top:25,left:120});b=e("<div>").html(m.back.content).attr("title",m.back.content).addClass(m.back.cls).bind("click",(function(i){return function(j){i._goBack()}})(this));o.append(a).append(p).append(d).append(b)};g._goBack=function(){var a=this.renderhist.length;if(a===1){return}this.renderhist.pop();a=this.renderhist.length;this.redraw(this.renderhist[a-1])};g._bindEvents=function(){var a=this;b();c();function c(){var d=a.events.datarangeselect;a.placeholder.unbind("plotselected").bind("plotselected",function(p,q){var n=Math.ceil(q.xaxis.from),r=Math.floor(q.xaxis.to);if(n>r){a.plot.clearSelection();return}var o=a.getRenderData(n,r);a.redraw(o);a.renderhist.push(o);d.call(a,a._transToPointData(o))})}function b(){var l=null,d=null,n=a.events.datapointhover.hoverin,m=a.events.datapointhover.hoverout;a.placeholder.unbind("plothover").bind("plothover",function(i,j,k){if(k){if(d!==k.dataIndex){d=k.dataIndex;clearTimeout(l);l=setTimeout(function(){var s=(e.grep(k.series.data,function(o,p){return o[0]===k.datapoint[0]&&o[1]===k.datapoint[1]}))[0];var t={x:s[0],y:s[1],color:k.series.color,label:k.series.label,data:s[2]};var r={top:k.pageY,left:k.pageX};n.call(a,r,t)},150)}}else{clearTimeout(l);m.call(a);d=null}})}};h.__config={base:{series:{lines:{show:true},points:{show:true}},grid:{hoverable:true,clickable:true},selection:{mode:"x"}},ui:{back:{content:"返回上一框选范围",cls:""},tip:{content:"可使用鼠标拖拽框选范围(按住鼠标左键,移动鼠标以框选范围)",cls:""},coord:{x:{content:"x轴",cls:""},y:{content:"y轴",cls:""}}}};h.__events={_datapreprocess:function(c){c=c||[];for(var d=0,b=c.length;d<b;++d){var a=c[d];if(a.label){a.label=e.tmpl.object(a.label,{count:a.data.length})}}return c},datapreprocess:function(a){return a},datarangeselect:f,datapointhover:{hoverin:f,hoverout:f}};return h});