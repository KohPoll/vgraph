(function(d){function c(x){var a={first:{x:-1,y:-1},second:{x:-1,y:-1},show:false,active:false};var v={};var y=null;function F(e){if(a.active){w(e);x.getPlaceholder().trigger("plotselecting",[D()])}}function u(e){if(e.which!=1){return}document.body.focus();if(document.onselectstart!==undefined&&v.onselectstart==null){v.onselectstart=document.onselectstart;document.onselectstart=function(){return false}}if(document.ondrag!==undefined&&v.ondrag==null){v.ondrag=document.ondrag;document.ondrag=function(){return false}}b(a.first,e);a.active=true;y=function(f){z(f)};d(document).one("mouseup",y)}function z(e){y=null;if(document.onselectstart!==undefined){document.onselectstart=v.onselectstart}if(document.ondrag!==undefined){document.ondrag=v.ondrag}a.active=false;w(e);if(E()){B()}else{x.getPlaceholder().trigger("plotunselected",[]);x.getPlaceholder().trigger("plotselecting",[null])}return false}function D(){if(!E()){return null}var e={},f=a.first,g=a.second;d.each(x.getAxes(),function(i,h){if(h.used){var j=h.c2p(f[h.direction]),k=h.c2p(g[h.direction]);e[i]={from:Math.min(j,k),to:Math.max(j,k)}}});return e}function B(){var e=D();x.getPlaceholder().trigger("plotselected",[e]);if(e.xaxis&&e.yaxis){x.getPlaceholder().trigger("selected",[{x1:e.xaxis.from,y1:e.yaxis.from,x2:e.xaxis.to,y2:e.yaxis.to}])}}function C(f,e,g){return e<f?f:(e>g?g:e)}function b(e,h){var f=x.getOptions();var g=x.getPlaceholder().offset();var i=x.getPlotOffset();e.x=C(0,h.pageX-g.left-i.left,x.width());e.y=C(0,h.pageY-g.top-i.top,x.height());if(f.selection.mode=="y"){e.x=e==a.first?0:x.width()}if(f.selection.mode=="x"){e.y=e==a.first?0:x.height()}}function w(e){if(e.pageX==null){return}b(a.second,e);if(E()){a.show=true;x.triggerRedrawOverlay()}else{A(true)}}function A(e){if(a.show){a.show=false;x.triggerRedrawOverlay();if(!e){x.getPlaceholder().trigger("plotunselected",[])}}}function s(m,i){var l,g,f,e,h=x.getAxes();for(var k in h){l=h[k];if(l.direction==i){e=i+l.n+"axis";if(!m[e]&&l.n==1){e=i+"axis"}if(m[e]){g=m[e].from;f=m[e].to;break}}}if(!m[e]){l=i=="x"?x.getXAxes()[0]:x.getYAxes()[0];g=m[i+"1"];f=m[i+"2"]}if(g!=null&&f!=null&&g>f){var j=g;g=f;f=j}return{from:g,to:f,axis:l}}function t(h,i){var f,g,e=x.getOptions();if(e.selection.mode=="y"){a.first.x=0;a.second.x=x.width()}else{g=s(h,"x");a.first.x=g.axis.p2c(g.from);a.second.x=g.axis.p2c(g.to)}if(e.selection.mode=="x"){a.first.y=0;a.second.y=x.height()}else{g=s(h,"y");a.first.y=g.axis.p2c(g.from);a.second.y=g.axis.p2c(g.to)}a.show=true;x.triggerRedrawOverlay();if(!i&&E()){B()}}function E(){var e=5;return Math.abs(a.second.x-a.first.x)>=e&&Math.abs(a.second.y-a.first.y)>=e}x.clearSelection=A;x.setSelection=t;x.getSelection=D;x.hooks.bindEvents.push(function(f,g){var e=f.getOptions();if(e.selection.mode!=null){g.mousemove(F);g.mousedown(u)}});x.hooks.drawOverlay.push(function(j,e){if(a.show&&E()){var l=j.getPlotOffset();var m=j.getOptions();e.save();e.translate(l.left,l.top);var i=d.color.parse(m.selection.color);e.strokeStyle=i.scale("a",0.8).toString();e.lineWidth=1;e.lineJoin="round";e.fillStyle=i.scale("a",0.4).toString();var g=Math.min(a.first.x,a.second.x),h=Math.min(a.first.y,a.second.y),f=Math.abs(a.second.x-a.first.x),k=Math.abs(a.second.y-a.first.y);e.fillRect(g,h,f,k);e.strokeRect(g,h,f,k);e.restore()}});x.hooks.shutdown.push(function(e,f){f.unbind("mousemove",F);f.unbind("mousedown",u);if(y){d(document).unbind("mouseup",y)}})}d.plot.plugins.push({init:c,options:{selection:{mode:null,color:"#e8cfac"}},name:"selection",version:"1.1"})})(jQuery);