(function(f){function e(aq){var T=null;var O=null;var aa=null;var Q=null;var X=null;var b=0;var am=true;var Z=10;var ai=0.95;var U=0;var ab=false;var ad=false;var R=[];aq.hooks.processOptions.push(V);aq.hooks.bindEvents.push(Y);function V(g,h){if(h.series.pie.show){h.grid.show=false;if(h.series.pie.label.show=="auto"){if(h.legend.show){h.series.pie.label.show=false}else{h.series.pie.label.show=true}}if(h.series.pie.radius=="auto"){if(h.series.pie.label.show){h.series.pie.radius=3/4}else{h.series.pie.radius=1}}if(h.series.pie.tilt>1){h.series.pie.tilt=1}if(h.series.pie.tilt<0){h.series.pie.tilt=0}g.hooks.processDatapoints.push(ao);g.hooks.drawOverlay.push(ah);g.hooks.draw.push(N)}}function Y(g,j){var h=g.getOptions();if(h.series.pie.show&&h.grid.hoverable){j.unbind("mousemove").mousemove(an)}if(h.series.pie.show&&h.grid.clickable){j.unbind("click").click(ae)}}function ak(h){var g="";function j(m,l){if(!l){l=0}for(var n=0;n<m.length;++n){for(var k=0;k<l;k++){g+="\t"}if(typeof m[n]=="object"){g+=""+n+":\n";j(m[n],l+1)}else{g+=""+n+": "+m[n]+"\n"}}}j(h);alert(g)}function P(g){for(var j=0;j<g.length;++j){var h=parseFloat(g[j].data[0][1]);if(h){b+=h}}}function ao(g,k,j,h){if(!ab){ab=true;T=g.getCanvas();O=f(T).parent();d=g.getOptions();g.setData(S(g.getData()))}}function ag(){U=O.children().filter(".legend").children().width();aa=Math.min(T.width,(T.height/d.series.pie.tilt))/2;X=(T.height/2)+d.series.pie.offset.top;Q=(T.width/2);if(d.series.pie.offset.left=="auto"){if(d.legend.position.match("w")){Q+=U/2}else{Q-=U/2}}else{Q+=d.series.pie.offset.left}if(Q<aa){Q=aa}else{if(Q>T.width-aa){Q=T.width-aa}}}function aj(g){for(var h=0;h<g.length;++h){if(typeof(g[h].data)=="number"){g[h].data=[[1,g[h].data]]}else{if(typeof(g[h].data)=="undefined"||typeof(g[h].data[0])=="undefined"){if(typeof(g[h].data)!="undefined"&&typeof(g[h].data.label)!="undefined"){g[h].label=g[h].data.label}g[h].data=[[1,0]]}}}return g}function S(j){j=aj(j);P(j);var k=0;var g=0;var m=d.series.pie.combine.color;var h=[];for(var l=0;l<j.length;++l){j[l].data[0][1]=parseFloat(j[l].data[0][1]);if(!j[l].data[0][1]){j[l].data[0][1]=0}if(j[l].data[0][1]/b<=d.series.pie.combine.threshold){k+=j[l].data[0][1];g++;if(!m){m=j[l].color}}else{h.push({data:[[1,j[l].data[0][1]]],color:j[l].color,label:j[l].label,angle:(j[l].data[0][1]*(Math.PI*2))/b,percent:(j[l].data[0][1]/b*100)})}}if(g>0){h.push({data:[[1,k]],color:m,label:d.series.pie.combine.label,angle:(k*(Math.PI*2))/b,percent:(k/b*100)})}return h}function N(j,l){if(!O){return}ctx=l;ag();var h=j.getData();var m=0;while(am&&m<Z){am=false;if(m>0){aa*=ai}m+=1;g();if(d.series.pie.tilt<=0.8){n()}k()}if(m>=Z){g();O.prepend('<div class="error">Could not draw pie with labels contained inside canvas</div>')}if(j.setSeries&&j.insertLegend){j.setSeries(h);j.insertLegend()}function g(){ctx.clearRect(0,0,T.width,T.height);O.children().filter(".pieLabel, .pieLabelBackground").remove()}function n(){var o=5;var p=15;var r=10;var q=0.02;if(d.series.pie.radius>1){var t=d.series.pie.radius}else{var t=aa*d.series.pie.radius}if(t>=(T.width/2)-o||t*d.series.pie.tilt>=(T.height/2)-p||t<=r){return}ctx.save();ctx.translate(o,p);ctx.globalAlpha=q;ctx.fillStyle="#000";ctx.translate(Q,X);ctx.scale(1,d.series.pie.tilt);for(var s=1;s<=r;s++){ctx.beginPath();ctx.arc(0,0,t,0,Math.PI*2,false);ctx.fill();t-=s}ctx.restore()}function k(){startAngle=Math.PI*d.series.pie.startAngle;if(d.series.pie.radius>1){var o=d.series.pie.radius}else{var o=aa*d.series.pie.radius}ctx.save();ctx.translate(Q,X);ctx.scale(1,d.series.pie.tilt);ctx.save();var p=startAngle;for(var r=0;r<h.length;++r){h[r].startAngle=p;q(h[r].angle,h[r].color,true)}ctx.restore();ctx.save();ctx.lineWidth=d.series.pie.stroke.width;p=startAngle;for(var r=0;r<h.length;++r){q(h[r].angle,d.series.pie.stroke.color,false)}ctx.restore();af(ctx);if(d.series.pie.label.show){s()}ctx.restore();function q(t,v,u){if(t<=0||isNaN(t)){return}if(u){ctx.fillStyle=v}else{ctx.strokeStyle=v;ctx.lineJoin="round"}ctx.beginPath();if(Math.abs(t-Math.PI*2)>1e-9){ctx.moveTo(0,0)}else{if(f.browser.msie){t-=0.0001}}ctx.arc(0,0,o,p,p+t,false);ctx.closePath();p+=t;if(u){ctx.fill()}else{ctx.stroke()}}function s(){var t=startAngle;if(d.series.pie.label.radius>1){var w=d.series.pie.label.radius}else{var w=aa*d.series.pie.label.radius}for(var u=0;u<h.length;++u){if(h[u].percent>=d.series.pie.label.threshold*100){v(h[u],t,u)}t+=h[u].angle}function v(L,D,F){if(L.data[0][1]==0){return}var G=d.legend.labelFormatter,K,I=d.series.pie.label.formatter;if(G){K=G(L.label,L)}else{K=L.label}if(I){K=I(K,L)}var C=((D+L.angle)+D)/2;var M=Q+Math.round(Math.cos(C)*w);var z=X+Math.round(Math.sin(C)*w)*d.series.pie.tilt;var H='<span class="pieLabel" id="pieLabel'+F+'" style="position:absolute;top:'+z+"px;left:"+M+'px;">'+K+"</span>";O.append(H);var ar=O.children("#pieLabel"+F);var J=(z-ar.height()/2);var E=(M-ar.width()/2);ar.css("top",J);ar.css("left",E);if(0-J>0||0-E>0||T.height-(J+ar.height())<0||T.width-(E+ar.width())<0){am=true}if(d.series.pie.label.background.opacity!=0){var B=d.series.pie.label.background.color;if(B==null){B=L.color}var A="top:"+J+"px;left:"+E+"px;";f('<div class="pieLabelBackground" style="position:absolute;width:'+ar.width()+"px;height:"+ar.height()+"px;"+A+"background-color:"+B+';"> </div>').insertBefore(ar).css("opacity",d.series.pie.label.background.opacity)}}}}}function af(g){if(d.series.pie.innerRadius>0){g.save();innerRadius=d.series.pie.innerRadius>1?d.series.pie.innerRadius:aa*d.series.pie.innerRadius;g.globalCompositeOperation="destination-out";g.beginPath();g.fillStyle=d.series.pie.stroke.color;g.arc(0,0,innerRadius,0,Math.PI*2,false);g.fill();g.closePath();g.restore();g.save();g.beginPath();g.strokeStyle=d.series.pie.stroke.color;g.arc(0,0,innerRadius,0,Math.PI*2,false);g.stroke();g.closePath();g.restore()}}function ap(j,h){for(var g=false,k=-1,m=j.length,l=m-1;++k<m;l=k){((j[k][1]<=h[1]&&h[1]<j[l][1])||(j[l][1]<=h[1]&&h[1]<j[k][1]))&&(h[0]<(j[l][0]-j[k][0])*(h[1]-j[k][1])/(j[l][1]-j[k][1])+j[k][0])&&(g=!g)}return g}function al(k,m){var h=aq.getData(),n=aq.getOptions(),g=n.series.pie.radius>1?n.series.pie.radius:aa*n.series.pie.radius;for(var l=0;l<h.length;++l){var j=h[l];if(j.pie.show){ctx.save();ctx.beginPath();ctx.moveTo(0,0);ctx.arc(0,0,g,j.startAngle,j.startAngle+j.angle,false);ctx.closePath();x=k-Q;y=m-X;if(ctx.isPointInPath){if(ctx.isPointInPath(k-Q,m-X)){ctx.restore();return{datapoint:[j.percent,j.data],dataIndex:0,series:j,seriesIndex:l}}}else{p1X=(g*Math.cos(j.startAngle));p1Y=(g*Math.sin(j.startAngle));p2X=(g*Math.cos(j.startAngle+(j.angle/4)));p2Y=(g*Math.sin(j.startAngle+(j.angle/4)));p3X=(g*Math.cos(j.startAngle+(j.angle/2)));p3Y=(g*Math.sin(j.startAngle+(j.angle/2)));p4X=(g*Math.cos(j.startAngle+(j.angle/1.5)));p4Y=(g*Math.sin(j.startAngle+(j.angle/1.5)));p5X=(g*Math.cos(j.startAngle+j.angle));p5Y=(g*Math.sin(j.startAngle+j.angle));arrPoly=[[0,0],[p1X,p1Y],[p2X,p2Y],[p3X,p3Y],[p4X,p4Y],[p5X,p5Y]];arrPoint=[x,y];if(ap(arrPoly,arrPoint)){ctx.restore();return{datapoint:[j.percent,j.data],dataIndex:0,series:j,seriesIndex:l}}}ctx.restore()}}return null}function an(g){ac("plothover",g)}function ae(g){ac("plotclick",g)}function ac(p,j){var o=aq.offset(),l=parseInt(j.pageX-o.left),n=parseInt(j.pageY-o.top),g=al(l,n);if(d.grid.autoHighlight){for(var m=0;m<R.length;++m){var k=R[m];if(k.auto==p&&!(g&&k.series==g.series)){W(k.series)}}}if(g){c(g.series,p)}var h={pageX:j.pageX,pageY:j.pageY};O.trigger(p,[h,g])}function c(h,g){if(typeof h=="number"){h=series[h]}var j=a(h);if(j==-1){R.push({series:h,auto:g});aq.triggerRedrawOverlay()}else{if(!g){R[j].auto=false}}}function W(g){if(g==null){R=[];aq.triggerRedrawOverlay()}if(typeof g=="number"){g=series[g]}var h=a(g);if(h!=-1){R.splice(h,1);aq.triggerRedrawOverlay()}}function a(g){for(var j=0;j<R.length;++j){var h=R[j];if(h.series==g){return j}}return -1}function ah(h,g){var j=h.getOptions();var l=j.series.pie.radius>1?j.series.pie.radius:aa*j.series.pie.radius;g.save();g.translate(Q,X);g.scale(1,j.series.pie.tilt);for(i=0;i<R.length;++i){k(R[i].series)}af(g);g.restore();function k(m){if(m.angle<=0||isNaN(m.angle)){return}g.fillStyle="rgba(255, 255, 255, "+j.series.pie.highlight.opacity+")";g.beginPath();if(Math.abs(m.angle-Math.PI*2)>1e-9){g.moveTo(0,0)}g.arc(0,0,l,m.startAngle,m.startAngle+m.angle,false);g.closePath();g.fill()}}}var d={series:{pie:{show:false,radius:"auto",innerRadius:0,startAngle:3/2,tilt:1,offset:{top:0,left:"auto"},stroke:{color:"#FFF",width:1},label:{show:"auto",formatter:function(b,a){return'<div style="font-size:x-small;text-align:center;padding:2px;color:'+a.color+';">'+b+"<br/>"+Math.round(a.percent)+"%</div>"},radius:1,background:{color:null,opacity:0},threshold:0},combine:{threshold:-1,color:null,label:"Other"},highlight:{opacity:0.5}}}};f.plot.plugins.push({init:e,options:d,name:"pie",version:"1.0"})})(jQuery);